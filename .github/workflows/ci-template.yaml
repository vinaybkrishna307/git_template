#name: CI
#
#on:
#  push:
#    branches: ["main"]
#
#permissions:
#  contents: read
#
#jobs:
#  build-validate:
#    runs-on: ubuntu-latest
#
#    outputs:
#      image_tag: ${{ steps.meta.outputs.tag }}
#
#    steps:
#      - name: Checkout Code
#        uses: actions/checkout@<PINNED_SHA>
#
#      - name: Setup Node
#        uses: actions/setup-node@v4
#        with:
#          node-version: 18
#
#      - name: Install Dependencies
#        run: npm install
#
#      # ---- UNIT TESTS ----
#      - name: Run Unit Tests with Coverage
#        run: npm test
#
#      # ---- LINT ----
#      - name: Run Lint
#        run: npm run lint
#
#      # ---- COVERAGE GATE ----
#      - name: Enforce Coverage Threshold
#        run: |
#          echo "Fail if coverage < 80%"
#          # In real pipeline: parse coverage report and fail
#
#      # ---- STATIC ANALYSIS ----
#      - name: Static Code Analysis
#        run: |
#          echo "sonar test"
##          sonar-scanner \
##            -Dsonar.projectKey=my-app \
##            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
##            -Dsonar.login=${{ secrets.SONAR_TOKEN }}
#
##      - name: Sonar Quality Gate
##        uses: sonarsource/sonarqube-quality-gate-action@master
##        timeout-minutes: 5
##        env:
##          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#
#  build:
#    runs-on: ubuntu-latest
#    needs: build-validate   # ← HARD GATEWAY
#
#    steps:
#      - uses: actions/checkout@<PINNED_SHA>
#
#      - name: Build Docker Image
#        run: |
#          IMAGE_TAG=${{ github.sha }}
#          docker build -t app:$IMAGE_TAG .
#
#      # ---- ARTIFACT SECURITY SCAN ----
#      - name: Artifact Scan
#        run: |
#          echo "This is where Trivy/Grype scan would run"
#          # trivy image app:${{ github.sha }}
#
##      - name: Install Trivy
##        run: |
##          sudo apt-get update
##          sudo apt-get install -y wget
##          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.1_Linux-64bit.deb
##          sudo dpkg -i trivy_0.50.1_Linux-64bit.deb
##
##      - name: Scan Docker Image
##        run: |
##          trivy image \
##            --severity HIGH,CRITICAL \
##            --exit-code 1 \
##            --format json \
##            -o trivy-report.json \
##            app:${{ github.sha }}
#
#      # ---- SBOM GENERATION ----
#      - name: Generate SBOM
#        run: |
#          echo "This is where Syft would generate SBOM"
#          # syft app:${{ github.sha }}
#
##      - name: Install Syft
##        run: |
##          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
##
##      - name: Generate SBOM
##        run: |
##          syft app:${{ github.sha }} -o json > sbom.json
#
#      - name: push artifact
#        run:  echo "pushing image"
#
#      - name: Install Cosign
#        run: echo "cosign"
##        uses: sigstore/cosign-installer@v3
##
##      - name: Sign Docker Image
##        env:
##          COSIGN_EXPERIMENTAL: "true"
##        run: |
##          cosign sign app:${{ github.sha }}
#
#      # ---- REPORT PUBLISHING ----
#      - name: Publish Reports
#        run: |
#          echo "Upload test results, coverage, and scan reports"
#
##      - name: Upload Security Reports
##        uses: actions/upload-artifact@v4
##        with:
##          name: security-reports
##          path: |
##            trivy-report.json
##            sbom.json
#
#      - name: Comment PR if Failed
#        if: failure()
#        uses: actions/github-script@v7
#        with:
#          script: |
#            github.rest.issues.createComment({
#              issue_number: context.issue.number,
#              owner: context.repo.owner,
#              repo: context.repo.repo,
#              body: "⚠️ PR validation failed. Please review test, lint, or security scan results."
#            })
#
#  QA-Deployment:
#    runs-on: self-hosted
#    needs: Dev-Deployment
#    steps:
#      - name: check out repo code
#        run: echo "check with QA"
##        uses: actions/checkout@v4
##        with:
##          repository: testVinaycicd/roboshop-helm
##
##      - name: Setup PATH and Deploy to QA
##        run: |
##          export PATH=/home/github/.local/bin:/home/github/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin
##  #          aws eks update-kubeconfig --name dev
##  #          make component=${{ inputs.component_name }} env=qa

name: Secure Build & Dev Deploy

on:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write

jobs:
  build-and-deploy-dev:
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t ghcr.io/${{ github.repository }}:$IMAGE_TAG .
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push Image
        run: docker push ghcr.io/${{ github.repository }}:${{ env.IMAGE_TAG }}

      - name: Scan Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}:${{ env.IMAGE_TAG }}
          severity: CRITICAL
          exit-code: 1

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ghcr.io/${{ github.repository }}:${{ env.IMAGE_TAG }}
          format: spdx-json
          output-file: sbom.json

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign Image
        run: cosign sign ghcr.io/${{ github.repository }}:${{ env.IMAGE_TAG }}

      - name: Deploy to Dev
        run: |
          kubectl set image deployment/app app=ghcr.io/${{ github.repository }}:${{ env.IMAGE_TAG }}