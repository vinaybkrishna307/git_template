#name: Feature Branch Validation
#
#on:
#  push:
#    branches:
#      - "develope/**"
#
#permissions:
#  contents: read
#
#jobs:
#  validate:
#    runs-on: ubuntu-latest
#
#    steps:
#      - uses: actions/checkout@v4
#
#      - uses: actions/setup-node@v4
#        with:
#          node-version: 18
#          cache: npm
#
#      - run: npm ci
#
#      - name: Unit Tests
#        run: npm test -- --coverage
#
#      - name: Lint
#        run: npm run lint
#
#      - name: Dependency Audit
#        run: npm audit --audit-level=high


name: Secure Build & Dev Deploy

on:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write

jobs:
  build-and-deploy-dev:
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t ghcr.io/${{ github.repository }}:$IMAGE_TAG .
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push with Provenance
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:${{ github.sha }}
          provenance: true

      - name: Scan Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}:${{ env.IMAGE_TAG }}
          severity: CRITICAL
          exit-code: 1

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ghcr.io/${{ github.repository }}:${{ env.IMAGE_TAG }}
          format: spdx-json
          output-file: sbom.json

      - name: Upload SBOM to Dependency Track
        run: |
          curl -X POST "$DT_URL/api/v1/bom" \
            -H "X-Api-Key: $DT_API_KEY" \
            -F "bom=@sbom.json"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign Image
        run: cosign sign ghcr.io/${{ github.repository }}:${{ env.IMAGE_TAG }}

      - name: Attest Build Provenance
        run: |
          cosign attest \
            --predicate-type slsaprovenance \
            ghcr.io/${{ github.repository }}:${{ github.sha }}

      - name: Deploy to Dev
        run: |
          kubectl set image deployment/app app=ghcr.io/${{ github.repository }}:${{ env.IMAGE_TAG }}